(function(){$(document).one("page:change",function(){return $("#chat-app").length?window.chatApp=new Vue({el:"#chat-app",directives:{"image-loaded":{update:function(e){return $(this.el).one("load",function(){return function(){return e.stopAction?void 0:window.chatApp.scrollToBottom()}}(this))}}},data:{content:"",searchName:"",closed:!0,initialized:!1,showConfig:!1,pcVersion:!1,mobileShowing:!1,progress:33,closure:!1,contacts:[],processingMessages:{},talkTo:null,flasher:new Mihuashi.FlashTitle("\u3010\u60a8\u6709\u65b0\u7684\u6d88\u606f\u3011- \u7c73\u753b\u5e08"),sound:new Audio(Mihuashi.upyunFileBucket+"/sound_effect/chat_pop.mp3"),config:{fullScreen:!1,enter:!0,sound:!0},currentUser:{id:"",token:"",avatar:""}},computed:{userHref:function(){return"/users/"+this.talkTo.name},contactLastLogin:function(){return $.timeago.settings.lang="zh-CN",$.timeago(this.talkTo.connected_at)},inputPlaceholder:function(){var e;return e=this.config.enter?"\u6309Enter\u53d1\u9001\u6d88\u606f":"\u6309Ctrl + Enter\u53d1\u9001\u6d88\u606f",e+="\uff0c\u4f7f\u7528QQ\u7b49\u4efb\u610f\u622a\u56fe\u5de5\u5177\u622a\u56fe\u540e\uff0c\u6309Ctrl + V\u5373\u53ef\u7c98\u8d34\u56fe\u7247\u5e76\u53d1\u9001\u3002"},totalNewMessagesCount:function(){var e;return e=_.flatten(this.contacts.map(function(e){return e.messages})).filter(function(e){return!e.readed}).length,0===e?this.flasher.stop():this.flasher.start(),0===e?null:e>99?"99+":e}},methods:{sendLoadContactsRequest:function(){return $.ajax({url:"/users/"+this.currentUser.id+"/contacts",type:"get",dataType:"json"})},sendLoadHistoryRequest:function(e){return $.ajax({url:"/chat_messages",data:e,dataType:"json"})},sendToggleReadedRequest:function(e,t){return $.ajax({url:"/chat_messages/"+e,type:"put",data:{state:t?2:1}})},sendSetMessagesReadedRequest:function(e){return $.ajax({url:"/chat_messages/readall",type:"put",data:{from_user_id:e}})},loadHistory:function(e){var t;return t={with_user_id:e.id,last_message_id:e.messages[0].id},this.sendLoadHistoryRequest(t).done(function(t){return e.hasMore=t.hasMore,t.chatMessages.map(function(e){return e.stopAction=!0}),e.messages=t.chatMessages.concat(e.messages)})},dealInputContent:function(e){return!this.config.enter&&e.ctrlKey&&13===e.keyCode||10===e.keyCode||this.config.enter&&!e.ctrlKey&&13===e.keyCode||10===e.keyCode?(e.preventDefault(),this.sendContent()):void 0},sendContent:function(){var e,t;if(null!=(t=this.content)?t.trim():void 0)return e=this.initMessageObj(this.content,"txt"),this.addMessage(this.talkTo,e),this.sendTxtChat(e),this.content=""},resend:function(e){return e.fail=!1,this.talkTo.messages.$remove(e),this.addMessage(this.talkTo,e),this.sendMessage(e)},pasteImage:function(e){var t,n,s,i,o,r,a,c;for(o=e.clipboardData.items,n=function(e,t){return e.lastModifiedDate=new Date,e.name=t,e},c=[],s=0,r=o.length;r>s;s++)i=o[s],"file"===i.kind&&i.type.match(/^image\//i)?(t=i.getAsFile(),a=new FileReader,a.onload=function(e){return function(s){var i;return t.url=s.target.result,i=n(t,"\u5c4f\u5e55\u622a\u56fe.jpg"),e.dealImageUpload({target:{files:[i]}})}}(this),c.push(a.readAsDataURL(t))):c.push(void 0);return c},dealImageUpload:function(e){var t,n;return(t=e.target.files[0])?t.size<=2048e3?(n=this.initMessageObj(URL.createObjectURL(t),"img"),this.addMessage(this.talkTo,n),this.sendImgChat(n,t)):(n=this.initMessageObj("[ \u56fe\u7247\u5927\u5c0f\u4e0d\u80fd\u8d85\u8fc72M\uff0c\u8bf7\u4f7f\u7528\u53d1\u9001\u6587\u4ef6 ]","txt"),n.sended=!0,this.addMessage(this.talkTo,n)):void 0},dealFileUpload:function(e){var t,n,s;return(n=e.target.files[0])?n.size<=15728640?(t={size:n.size,name:n.name},s=this.initMessageObj(JSON.stringify(t),"file"),this.addMessage(this.talkTo,s),this.sendFileChat(s,n)):(s=this.initMessageObj("[ \u6587\u4ef6\u5927\u5c0f\u4e0d\u80fd\u8d85\u8fc715M ]","txt"),s.sended=!0,this.addMessage(this.talkTo,s)):void 0},setMessagesReaded:function(){return 0!==this.talkTo.messages.filter(function(e){return!e.readed}).length?(this.sendSetMessagesReadedRequest(this.talkTo.id),this.talkTo.messages.map(function(e){return e.readed=!0})):void 0},initRongCloud:function(){var e;return e=$.Deferred(),RongIMClient.init(Mihuashi.rongCloudAppKey),RongIMClient.setConnectionStatusListener({onChanged:function(e){return function(t){switch(t){case RongIMLib.ConnectionStatus.CONNECTED:return console.log("\u94fe\u63a5\u6210\u529f");case RongIMLib.ConnectionStatus.CONNECTING:return console.log("\u6b63\u5728\u94fe\u63a5");case RongIMLib.ConnectionStatus.DISCONNECTED:return console.log("\u65ad\u5f00\u8fde\u63a5"),e.appClosure();case RongIMLib.ConnectionStatus.KICKED_OFFLINE_BY_OTHER_CLIENT:return console.log("\u5176\u4ed6\u8bbe\u5907\u767b\u9646"),e.appClosure();case RongIMLib.ConnectionStatus.NETWORK_UNAVAILABLE:return console.log("\u7f51\u7edc\u4e0d\u53ef\u7528"),e.appClosure();default:return console.log(t),e.appClosure()}}}(this)}),RongIMClient.setOnReceiveMessageListener({onReceived:function(e){return function(t){var n,s,i,o,r,a,c,u;if(!t.receivedStatus){switch(a=new Date(t.sentTime),o=+t.senderUserId,c=e.currentUser.id,u=function(t,n){var s,i;return s={content:t,fromUserId:o,toUserId:c,sended:!0,sendedAt:a,readed:!(o!==(null!=(i=e.talkTo)?i.id:void 0)),objectName:n}},t.messageType){case RongIMClient.MessageType.TextMessage:i=t.content.content,r=u(i,"txt");break;case RongIMClient.MessageType.ImageMessage:i=t.content.imageUri,r=u(i,"img");break;case RongIMClient.MessageType.RichContentMessage:i=t.content.content,r=u(i,"file")}return r.msgUId=t.messageUId,t.senderUserId===t.targetId?(e.config.sound&&e.sound.play(),s=_.find(e.contacts,{id:o}),s?e.addMessage(s,r):((n=e.processingMessages)[o]||(n[o]=[]),e.processingMessages[o].push(r),e.addContactsForReceiver(o,r)),e.toggleApp(!0),e.sendToggleReadedRequest(o,r.readed)):(r.readed=!0,s=_.find(e.contacts,{id:+t.targetId}),e.addMessage(s,r))}}}(this)}),RongIMClient.connect(this.currentUser.token,{onSuccess:function(){return e.resolve()},onError:function(e){return console.log(e)}}),e},reconnect:function(){return RongIMClient.reconnect({onSuccess:function(e){return function(){return e.closure=!1,e.initialized=!0}}(this)})},sendMessage:function(e){var t,n;switch(e.objectName){case"txt":n=new RongIMLib.TextMessage({content:e.content});break;case"img":n=new RongIMLib.ImageMessage({content:"",imageUri:e.content});break;case"file":n=new RongIMLib.RichContentMessage({content:e.content,imageUri:"",title:""})}return t=RongIMLib.ConversationType.PRIVATE,RongIMClient.getInstance().sendMessage(t,e.toUserId,n,{onSuccess:function(){return e.sended=!0},onError:function(t){return console.log(t),Mihuashi.Mixpanel.track("Chat Error",{code:t}),e.fail=!0}})},sendTxtChat:function(e){return this.sendMessage(e)},sendImgChat:function(e,t){var n;return n=$.Deferred(),n.done(function(t){return function(n){var s;return s=JSON.parse(n),e.content=Mihuashi.upyunFileBucket+s.url,t.sendMessage(e)}}(this)),Mihuashi.fileUpload({file:t},this.updateMsgProgress(e),n,{upload_to:"file"})},sendFileChat:function(e,t){var n;return n=$.Deferred(),n.done(function(t){return function(n){var s,i;return i=JSON.parse(n),s=JSON.parse(e.content),s.url=Mihuashi.upyunFileBucket+i.url,e.content=JSON.stringify(s),t.sendMessage(e)}}(this)),Mihuashi.fileUpload({file:t},this.updateMsgProgress(e),n,{upload_to:"file"})},updateMsgProgress:function(e){return function(t){return e.progress=(t.loaded/t.total*100).toFixed(1)}},selectImage:function(e){return $(e.currentTarget).siblings(".chat-app-upload-image").click()},selectFile:function(e){return $(e.currentTarget).siblings(".chat-app-upload-file").click()},chatTo:function(e){var t;if(this.initialized)return this.closure?AlertMessage.show({type:"info",text:"\u804a\u5929\u5de5\u5177\u5df2\u7ecf\u65ad\u5f00\u8fde\u63a5\uff0c\u8bf7\u5148\u70b9\u51fb\u9875\u9762\u53f3\u4e0b\u89d2\u91cd\u65b0\u94fe\u63a5\u3002",timeout:3e3}):(t=_.find(this.contacts,{id:e.id}),this.closed=!1,this.pcVersion||this.mobileToggle(),t?this.selectUser(t):(e.selected=!0,e.showTips=!1,e.contacted_at=new Date,e.messages=[],this.contacts.push(e),this.selectUser(e),this.addContacts(e)))},initMessageObj:function(e,t){var n;return n={content:e,fromUserId:this.currentUser.id,toUserId:this.talkTo.id+"",sended:!1,readed:!0,fail:!1,progress:0,sendedAt:new Date,objectName:t}},msgAlreadyExist:function(e,t){var n;return void 0===t.msgUId?!1:void 0===e[0]?!1:(n=e.map(function(e){return e.msgUId}),_.contains(n,t.msgUId)?!0:t.sendedAt<=e[0].sendedAt)},addMessage:function(e,t){return this.msgAlreadyExist(e.messages,t)?void 0:(e.messages.push(t),"system"!==t.objectName&&(e.contacted_at=(new Date).getTime()),this.scrollToBottom())},addContacts:function(e){return $.ajax({url:"/contact_relationships",data:{user_id:e.id},type:"post"}).done(function(){return AlertMessage.show({type:"success",text:e.name+" \u5df2\u7ecf\u6210\u529f\u52a0\u5165\u8054\u7cfb\u4eba\u5217\u8868",timeout:3e3})})},addContactsForReceiver:function(e){return $.ajax({url:"/contact_relationships",type:"post",data:{user_id:e},dataType:"json"}).done(function(e){return function(t){var n;return n=JSON.parse(t),n.messages=e.processingMessages[n.id],n.selected=n.showTips=!1,n.contacted_at=new Date,_.find(e.contacts,{id:n.id})?void 0:e.contacts.push(n)}}(this))},timeDiff:function(e){var t,n,s,i;return 0===e?!0:(n=this.talkTo.messages[e],i=this.talkTo.messages[e-1],t=new Date(n.sendedAt),s=new Date(i.sendedAt),t-s>18e4)},timeText:function(e){var t,n,s,i,o,r;return r=new Date,t=new Date(e.sendedAt),o=t.getMonth()+1,n=t.getDate(),s=Mihuashi.zeroFill(t.getHours(),2),i=Mihuashi.zeroFill(t.getMinutes(),2),r.getMonth()+1===o&&r.getDate()===n?"\u4eca\u5929 "+s+" : "+i:o+"\u6708"+n+"\u65e5 "+s+" : "+i},toggleApp:function(e){var t;return _.isUndefined(e)&&(e=this.closed),e||(null!=(t=this.talkTo)&&(t.selected=!1),this.talkTo=null,this.showConfig=!1,this.lockView(!1)),this.closed=!e},appClosure:function(){return this.closure=!0,this.toggleApp(!1)},updateProgress:function(){return setTimeout(function(e){return function(){return e.initialized?e.progress=100:e.progress+=e.progress<95?2:e.progress<99?.5:.01,e.initialized?void 0:e.updateProgress()}}(this),100)},selectUser:function(e){var t;return null!=(t=this.talkTo)&&(t.selected=!1),this.talkTo=e,this.talkTo.selected=!0,this.lockView(this.config.fullScreen),this.showTips(),this.setMessagesReaded(),Vue.nextTick(function(e){return function(){return $("#chat-app-history").perfectScrollbar("destroy"),$("#chat-app-history").perfectScrollbar(),e.scrollToBottom()}}(this))},scrollToBottom:function(){return Vue.nextTick(function(){return $("#chat-app-history").scrollTop(1e5),$("#chat-app-history").perfectScrollbar("update")})},ownerAvatar:function(e){return e.fromUserId!==this.currentUser.id?this.talkTo.avatar_url:this.currentUser.avatar},changeConfig:function(e){return this.config[e]=!this.config[e],this.showConfig=!1,"fullScreen"===e&&this.lockView(this.config[e]),$.cookie("chatAppConfig",JSON.stringify(this.config),{expires:365})},lockView:function(e){return e&&!this.closed?$("body").addClass("modal-open"):$("body").removeClass("modal-open")},showTips:function(){return this.talkTo.showTips?void 0:(this.talkTo.messages.push({objectName:"system",readed:!0}),this.talkTo.showTips=!0)},newMessagesCount:function(e){var t;return t=e.messages.filter(function(e){return!e.readed}).length,0===t?null:t>99?"99+":t},fileName:function(e){var t;return t=JSON.parse(e),t.name},fileSize:function(e){var t;return t=JSON.parse(e),t.size>=1048576?(t.size/1048576).toFixed(1)+"MB":(t.size/1024).toFixed(1)+"KB"},fileUrl:function(e){var t;return t=JSON.parse(e),t.url},mobileToggle:function(){return this.mobileShowing===!1?$("body").addClass("modal-open"):$("body").removeClass("modal-open"),this.config.fullScreen=!0,this.closed=!1,this.mobileShowing=!this.mobileShowing},lastMessage:function(e){var t;return(t=_.last(e.messages.filter(function(e){return"system"!==e.objectName})))?"txt"===t.objectName?t.content:"img"===t.objectName?"[ \u56fe\u7247 ]":"file"===t.objectName?"[ \u6587\u4ef6 ]":void 0:void 0},lastMessageAt:function(e){var t,n,s;return(n=_.last(e.messages.filter(function(e){return"system"!==e.objectName})))?(s=new Date(n.sendedAt),t=new Date-s,864e5>t?Mihuashi.zeroFill(s.getHours(),2)+":"+Mihuashi.zeroFill(s.getMinutes(),2):1728e5>t?"\u6628\u5929":Mihuashi.zeroFill(s.getMonth()+1,2)+"-"+Mihuashi.zeroFill(s.getDate(),2)):void 0},returnToList:function(){var e;return null!=(e=this.talkTo)&&(e.selected=!1),this.talkTo=null}},ready:function(){var e,t;return this.updateProgress(),e=$("#chat-app"),this.pcVersion=e.data("pc-version"),this.currentUser.id=e.data("id"),this.currentUser.token=e.data("token"),this.currentUser.avatar=e.data("avatar"),t=$.cookie("chatAppConfig"),t&&(this.config=JSON.parse(t)),this.sendLoadContactsRequest().done(function(e){return function(t){return e.contacts=t.map(function(e){return e.showTips=e.selected=!1,e.messageHasMore=20===e.messages.length,e}),e.initRongCloud().done(function(){return e.initialized=!0})}}(this))}}):void 0})}).call(this);